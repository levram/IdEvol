<!DOCTYPE html>
<script type="text/javascript" src="./knockout-2.0.0.js"></script>
<!--<script type="text/javascript" src="./jquery-1.7.1.min.js"></script>-->
<style type="text/css">
.container {
  border: 1px solid gray;
  width: 600px;
  height: 600px;
  overflow: hidden;
  position: relative;
  margin: 20px;
}
.agent {
  /*padding: 10px;*/
  /*margin: auto auto;*/
  text-align: center;
  position: absolute;
  border: 2px solid black;
  border-radius: 9999px;
}
</style>
<div class="container" data-bind="text:'Objective reality', foreach: agents">
  <div class="agent" data-bind="
    { attr: {title: ko.toJSON($data)}
    , text: name
    , style:
      { top: 525-intelligence()*5 + 'px'
      , left: 25+identity()*5 + 'px'
      , width: (energy()/2) + 'px'
      , height: (energy()/2) + 'px'
      , backgroundColor: 'hsl('+identity()*3.3+',90%,'+(20+intelligence()*0.7)+'%)'
      }
    }
  "></div>
</div>
<div data-bind="foreach: agents">
  <div class="container" data-bind="text: 'Inner observations of '+name(), foreach: observed">
    <div class="agent" data-bind="
      { attr: {title: ko.toJSON($data)}
      , text: name
      , style:
        { top: 525-intelligence()*5 + 'px'
        , left: 25+identity()*5 + 'px'
        , width: (energy()/2) + 'px'
        , height: (energy()/2) + 'px'
        , backgroundColor: 'hsl('+identity()*3.3+',90%,'+(20+intelligence()*0.7)+'%)'
        }
      }
    "></div>
  </div>
</div>

<script type="text/javascript">
var vA = // viewAdapter
  { toY: function(value) {
      return (500-value*5) + 'px'
    }
  , toX: function(v) {
      return (5*v)+'px'
    }
  }
var nrnd = function(avg, dist) {
  return Math.round(avg-dist+(Math.random()*dist*2))
}

var agentModel = function(opts) {
  if (typeof opts != 'object') {opts = {}}
  var o = 
    { energy: ko.observable(nrnd(80, 20))
    , intelligence: ko.observable(nrnd(50, 50))
    , identity: ko.observable(nrnd(50, 50))
    , observed: ko.observableArray([])
  }
  for (var key in opts) if (opts.hasOwnProperty(key)) {
    opts[key] = ko.observable(opts[key])
  }
  for (var key in o) if (o.hasOwnProperty(key)) {
    opts[key] = o[key]
  }
  opts.toString = function() {
    return JSON.stringify(this);
  }
  return opts
}

var agents = ko.observableArray([])
for (var i = 0; i < 10; i++) {
  agents.push(new agentModel({x:0, y:i*10, name:i}))
}
ko.applyBindings({agents:agents})
</script>